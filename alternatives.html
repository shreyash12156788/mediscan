<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Related Medicines | MediScan</title>
    <link rel="stylesheet" href="css/style.css">

    <style>
        /* Extra UI polish for top section */
        .top-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            max-width: 420px;
            margin: auto;
        }

        .loader {
            margin: 18px auto;
            width: 36px;
            height: 36px;
            border: 4px solid #ddd;
            border-top: 4px solid #1E88E5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .note {
            font-size: 13px;
            color: #555;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- TOP UI CARD -->
    <div class="top-card">
        <h1 class="logo">üíä MediScan</h1>
        <p class="tagline">Finding Related Medicines‚Ä¶</p>

        <div style="max-width:420px;margin:auto;margin-top:12px;">
            <form id="manualSearchForm" style="display:flex;gap:8px;">
                <input id="manualQuery" type="text" placeholder="Enter medicine or salt (e.g. paracetamol)" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;" />
                <button id="searchBtn" type="submit" class="btn" style="padding:10px 14px;">Search</button>
            </form>
        </div>

        <div id="altList" style="margin-top:16px; text-align:left; max-width:420px; margin-left:auto; margin-right:auto;"></div>

        <p id="infoText">
            Loading alternatives‚Ä¶
        </p>

        <p class="note">
            ‚ö†Ô∏è Information purpose only. Consult a doctor before use.
        </p>

        <p class="back">
            <a href="dashboard.html">‚Üê Back to Dashboard</a>
        </p>
    </div>
</div>

    <!-- Firebase modular initializer -->
    <script type="module" src="js/firebase-module.js"></script>
    <script src="js/main.js"></script>
    <script>
        const medicineName = localStorage.getItem("medicineName");
        const salt = localStorage.getItem("salt");
        const manualQuery = localStorage.getItem("manualQuery");

        const infoText = document.getElementById("infoText");
        const altList = document.getElementById("altList");

        function renderAlternatives(items) {
            if (!items || items.length === 0) {
                altList.innerHTML = '<p>No in-app alternatives found.</p>';
                return;
            }

            const ul = document.createElement('ul');
            ul.style.padding = '0 14px';
            ul.style.listStyle = 'none';

            items.forEach(it => {
                const li = document.createElement('li');
                li.style.padding = '10px 0';

                const title = document.createElement('div');
                title.style.fontWeight = '600';
                title.innerText = it.name;

                const note = document.createElement('div');
                note.style.fontSize = '13px';
                note.style.color = '#555';
                note.innerText = it.note || '';

                const ext = document.createElement('a');
                ext.style.display = 'inline-block';
                ext.style.marginTop = '6px';
                ext.href = 'https://www.1mg.com/search/all?name=' + encodeURIComponent(it.name);
                ext.target = '_blank';
                ext.rel = 'noopener noreferrer';
                ext.innerText = 'View on 1mg';

                li.appendChild(title);
                li.appendChild(note);
                li.appendChild(ext);
                ul.appendChild(li);
            });

            altList.innerHTML = '';
            altList.appendChild(ul);
        }

        function showNoResults(query) {
            altList.innerHTML = '<p>No in-app alternatives found for "' + escapeHtml(query) + '".</p>' +
                '<p style="margin-top:8px">' +
                '<a href="https://www.1mg.com/search/all?name=' + encodeURIComponent(query) + '" target="_blank" rel="noopener">Search on 1mg</a>' +
                ' or ' +
                '<a href="https://www.google.com/search?q=' + encodeURIComponent(query + ' alternative medicines') + '" target="_blank" rel="noopener">Google</a>' +
                '</p>' +
                '<p style="margin-top:10px">' +
                '<button onclick="externalLookup(' + JSON.stringify(query) + ')" class="btn">Use external lookup (OpenFDA)</button>' +
                '</p>';

            // Auto-trigger external lookup once to improve UX (tries OpenFDA then mock fallback).
            try {
                if (!window._externalLookupAutoTried) {
                    window._externalLookupAutoTried = true;
                    setTimeout(() => externalLookup(query), 700);
                }
            } catch (e) {
                console.warn('Auto external lookup failed to start', e);
            }
        }

        // External lookup via server proxy (/api/alternatives)
        // Tries same-origin first, then falls back to http://localhost:4000
        function externalLookup(query) {
            if (!query) return;
            infoText.innerText = 'Looking up externally for: ' + query;
            altList.innerHTML = '<p>Loading external results‚Ä¶</p>';

            const relUrl = '/api/alternatives?q=' + encodeURIComponent(query);
            const absUrl = 'http://localhost:4000/api/alternatives?q=' + encodeURIComponent(query);

            function tryFetch(url) {
                return fetch(url, { cache: 'no-store' }).then(resp => {
                    if (!resp.ok) {
                        const err = new Error('HTTP ' + resp.status);
                        err.response = resp;
                        throw err;
                    }
                    return resp.json();
                });
            }

            tryFetch(relUrl)
                .catch(err => {
                    console.warn('Relative fetch failed, trying localhost proxy:', err.message || err);
                    return tryFetch(absUrl);
                })
                .then(data => {
                    if (!data || !data.items || data.items.length === 0) {
                        // Try mock fallback on the same server
                        fetch('/api/alternatives-mock?q=' + encodeURIComponent(query))
                            .then(r => r.json())
                            .then(mock => {
                                if (mock && mock.items && mock.items.length) {
                                    infoText.innerText = 'Showing fallback results for: ' + query;
                                    renderAlternatives(mock.items);
                                } else {
                                        // If mock returned nothing, render a local client-side mock so UI remains usable
                                        renderLocalMock(query);
                                }
                            }).catch(merr => {
                                console.error('Mock fallback failed', merr);
                                    // If fetching the server mock fails, render a local client-side mock so UI remains usable
                                    renderLocalMock(query);
                            });
                        return;
                    }
                    renderAlternatives(data.items);
                })
                .catch(err => {
                    console.error('External lookup failed:', err);
                    // On any error, try the mock fallback endpoint before showing final error
                    fetch('/api/alternatives-mock?q=' + encodeURIComponent(query))
                        .then(r => r.json())
                        .then(mock => {
                            if (mock && mock.items && mock.items.length) {
                                infoText.innerText = 'Showing fallback results for: ' + query;
                                renderAlternatives(mock.items);
                            } else {
                                    renderLocalMock(query);
                            }
                        }).catch(merr => {
                            console.error('Mock fallback failed', merr);
                                renderLocalMock(query);
                        });
                });
        }

        function escapeHtml(s) {
            return s.replace(/[&<>"]+/g, function(c) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]); });
        }

        // Local client-side mock fallback: used if server/OpenFDA not available
        function renderLocalMock(query) {
            const q = query || 'sample';
            const items = [
                { name: q + ' - Generic (mock)', note: 'Local mock alternative' },
                { name: q + ' Plus (mock)', note: 'Local mock brand' }
            ];
            infoText.innerText = 'Showing local fallback results for: ' + q;
            renderAlternatives(items);
        }

        // initial render: prefer manual query (from Dashboard), then scanned salt/name
        if (manualQuery) {
            const res = findAlternatives(manualQuery);
            if (res.canonical) {
                infoText.innerText = 'Alternatives for: ' + manualQuery + ' (matched to ' + res.canonical + ')';
                renderAlternatives(res.items);
            } else if (res.items.length) {
                infoText.innerText = 'Alternatives for: ' + manualQuery;
                renderAlternatives(res.items);
            } else {
                infoText.innerText = 'No exact in-app alternatives for: ' + manualQuery;
                showNoResults(manualQuery);
            }

            // clear manual query so it doesn't persist
            localStorage.removeItem('manualQuery');
        } else if (salt) {
            infoText.innerText = 'Alternatives for: ' + salt;
            const items = getAlternativesForSalt(salt);
            if (items.length) renderAlternatives(items); else showNoResults(salt);
        } else if (medicineName) {
            infoText.innerText = 'Alternatives for: ' + medicineName;
            const items = getAlternativesForName(medicineName);
            if (items.length) renderAlternatives(items); else showNoResults(medicineName);
        } else {
            infoText.innerText = 'No medicine detected. You can type a name below.';
            altList.innerHTML = '<p style="color:#666">Try scanning a medicine or enter a name above to search.</p>';
        }

        // manual search handler
        const form = document.getElementById('manualSearchForm');
        const queryInput = document.getElementById('manualQuery');

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const q = (queryInput.value || '').trim();
            if (!q) return;
            infoText.innerText = 'Searching for: ' + q;
            const res = findAlternatives(q);
            if (res.canonical) {
                infoText.innerText = 'Searching for: ' + q + ' (matched to ' + res.canonical + ')';
                renderAlternatives(res.items);
            } else if (res.items.length) {
                renderAlternatives(res.items);
            } else {
                showNoResults(q);
            }
        });
    </script>

</body>
</html>
